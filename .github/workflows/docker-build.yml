name: ci-compose-build

on:
  push:
    branches: ["ci"]

jobs:
  build-containers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env.local for docker-compose
        shell: bash
        run: |
          cat > .env.local << 'EOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ vars.JWT_EXPIRES_IN }}
          NODE_ENV=${{ vars.NODE_ENV }}
          CORS_ORIGIN=${{ vars.CORS_ORIGIN }}
          REACT_APP_API_BASE_URL=${{ vars.REACT_APP_API_BASE_URL }}
          EOF

      - name: Docker info
        run: |
          docker version
          docker compose version

      - name: Build images
        run: docker compose build

      - name: Create containers (no start)
        run: docker compose up --build --no-start

      - name: Show containers
        run: docker compose ps -a

      - name: Cleanup
        if: always()
        run: docker compose down -v || true

  smoke-frontend:
    runs-on: ubuntu-latest
    needs: build-containers

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env.local for docker-compose
        shell: bash
        run: |
          cat > .env.local << 'EOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ vars.JWT_EXPIRES_IN }}
          NODE_ENV=${{ vars.NODE_ENV }}
          CORS_ORIGIN=${{ vars.CORS_ORIGIN }}
          REACT_APP_API_BASE_URL=${{ vars.REACT_APP_API_BASE_URL }}
          EOF

      - name: Docker info
        run: |
          docker version
          docker compose version

      # Démarre uniquement le frontend, sans dépendances (évite backend/prisma)
      - name: Start frontend only
        run: docker compose up -d --build --no-deps frontend

      - name: Show containers
        run: docker compose ps

      # Vérifie que le serveur web répond sur le port publié (3000 -> 80) :contentReference[oaicite:1]{index=1}
      - name: Smoke test frontend HTTP
        shell: bash
        run: |
          set -e

          echo "Waiting for http://localhost:3000 ..."
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:3000 >/dev/null; then
              echo "Frontend is up ✅"
              exit 0
            fi
            sleep 2
          done

          echo "Frontend did not respond in time ❌"
          docker compose logs --no-color frontend || true
          exit 1

      - name: Logs
        if: always()
        run: docker compose logs --no-color || true

      - name: Cleanup
        if: always()
        run: docker compose down -v || true
