name: ci-compose-build

on:
  push:
    branches: ["ci"]

jobs:
  compose-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env.local for docker-compose
        shell: bash
        run: |
          cat > .env.local << 'EOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ vars.JWT_EXPIRES_IN }}
          NODE_ENV=${{ vars.NODE_ENV }}
          CORS_ORIGIN=${{ vars.CORS_ORIGIN }}
          REACT_APP_API_BASE_URL=${{ vars.REACT_APP_API_BASE_URL }}
          EOF

      - name: Docker info
        run: |
          docker version
          docker compose version

      - name: Build images
        run: docker compose build

      - name: Create containers (no start)
        run: docker compose up --build --no-start

      - name: Show containers
        run: docker compose ps -a

      - name: Cleanup
        if: always()
        run: docker compose down -v || true
