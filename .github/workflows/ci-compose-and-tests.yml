name: ci-compose-and-tests

on:
  push:
    branches: ["ci"]

jobs:
  compose-and-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker info
        run: |
          docker version
          docker compose version

      - name: Create .env.local for docker-compose
        shell: bash
        run: |
          cat > .env.local << 'EOF'
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ vars.JWT_EXPIRES_IN }}
          NODE_ENV=${{ vars.NODE_ENV }}
          CORS_ORIGIN=${{ vars.CORS_ORIGIN }}
          REACT_APP_API_BASE_URL=${{ vars.REACT_APP_API_BASE_URL }}
          EOF

      - name: Build and start
        run: docker compose up -d --build

      - name: Tests (backend + frontend in parallel)
        shell: bash
        run: |
          set -e

          (docker compose exec -T backend sh -lc "npm ci && npm test") &
          BACK_PID=$!

          (docker compose exec -T frontend sh -lc "npm ci && CI=true npm test -- --watchAll=false") &
          FRONT_PID=$!

          wait ${BACK_PID}
          wait ${FRONT_PID }

      - name: Logs
        if: always()
        run: docker compose logs --no-color || true

      - name: Down
        if: always()
        run: docker compose down -v || true
