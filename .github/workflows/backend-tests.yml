name: CI - Backend tests

on:
  pull_request:
    paths:
      - "backend/**"
      - ".github/workflows/**"
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - ".github/workflows/**"

jobs:
  backend-unit:
    name: Backend - unit/int tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Run tests
        run: npm test

  # Optionnel: active ce job si tu veux exécuter les e2e (nécessite une DB Postgres).
  # backend-e2e:
  #   name: Backend - e2e
  #   runs-on: ubuntu-latest
  #
  #   services:
  #     postgres:
  #       image: postgres:16
  #       env:
  #         POSTGRES_USER: postgres
  #         POSTGRES_PASSWORD: postgres
  #         POSTGRES_DB: mvp_test
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd="pg_isready -U postgres"
  #         --health-interval=10s
  #         --health-timeout=5s
  #         --health-retries=10
  #
  #   defaults:
  #     run:
  #       working-directory: backend
  #
  #   env:
  #     # Important: les e2e chargent aussi .env.local via test/jest-e2e.setup.ts,
  #     # donc on force les vars ici pour rendre la CI hermétique.
  #     DATABASE_URL: postgresql://postgres:postgres@localhost:5432/mvp_test?schema=public
  #     JWT_SECRET: test_secret
  #     JWT_EXPIRES_IN: 3600s
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 22
  #         cache: npm
  #         cache-dependency-path: backend/package-lock.json
  #
  #     - name: Install deps
  #       run: npm ci
  #
  #     - name: Prisma generate
  #       run: npx prisma generate
  #
  #     - name: Apply migrations
  #       run: npx prisma migrate deploy
  #
  #     - name: Run e2e tests
  #       run: npm run test:e2e

